<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebAR Multitarget Spritesheet</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <script>
      AFRAME.registerComponent('sprite-sheet', {
        schema: {
          cols: {type: 'number', default: 1},
          rows: {type: 'number', default: 1},
          totalFrames: {type: 'number', default: 1},
          fps: {type: 'number', default: 24},
          loop: {type: 'boolean', default: true}
        },
        init: function () {
          this.timer = 0;
          this.currentFrame = 0;
          this.textureLoaded = false;

          // Função auxiliar para configurar a textura assim que estiver disponível
          this.setupTexture = () => {
            this.mesh = this.el.getObject3D('mesh');
            // Verifica se a malha e o mapa de textura existem
            if (this.mesh && this.mesh.material.map) {
                this.texture = this.mesh.material.map;
                // Configura a repetição (tiling) da textura baseado nas colunas e linhas
                this.texture.repeat.set(1 / this.data.cols, 1 / this.data.rows);
                // Aplica o offset inicial
                this.updateOffset();
                this.textureLoaded = true;
            }
          };

          // Tenta configurar imediatamente (caso esteja em cache)
          this.setupTexture();

          // Se não, adiciona um ouvinte para quando a textura terminar de carregar
          this.el.addEventListener('materialtextureloaded', () => {
              this.setupTexture();
          });
        },
        tick: function (time, timeDelta) {
          // Se a textura não carregou, não faz nada
          if (!this.textureLoaded || !this.texture) return;

          this.timer += timeDelta;
          // Controle de FPS usando o delta time
          if (this.timer > 1000 / this.data.fps) {
            this.currentFrame++;
            
            // Lógica de Loop
            if (this.currentFrame >= this.data.totalFrames) {
              if (this.data.loop) {
                this.currentFrame = 0;
              } else {
                this.currentFrame = this.data.totalFrames - 1; // Para no último frame se loop for false
              }
            }
            
            this.updateOffset();
            this.timer = 0;
          }
        },
        updateOffset: function () {
           // Cálculo matemático para mover a "janela" de visualização da textura
          const col = this.currentFrame % this.data.cols;
          const row = Math.floor(this.currentFrame / this.data.cols);
          
          this.texture.offset.x = col / this.data.cols;
          // Inversão do eixo Y necessária para coordenadas de textura WebGL
          this.texture.offset.y = (this.data.rows - 1 - row) / this.data.rows;
        }
      });
    </script>
</head>

<body>
    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">

        <a-assets>
            <img id="tex-anim0" src="./animacao0.png" crossorigin="anonymous">
            <img id="tex-anim1" src="./animacao1.png" crossorigin="anonymous">
            </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-image 
                src="#tex-anim0" 
                position="0 0 0" 
                scale="1 1 1" 
                rotation="0 0 0" 
                alpha-test="0.5"
                sprite-sheet="cols: 5; rows: 6; totalFrames: 26; fps: 24; loop: true">
            </a-image>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 1">
            <a-image 
                src="#tex-anim1" 
                position="0 0 0" 
                scale="1 1 1" 
                rotation="0 0 0" 
                alpha-test="0.5"
                sprite-sheet="cols: 5; rows: 4; totalFrames: 16; fps: 24; loop: true">
            </a-image>
        </a-entity>

        </a-scene>
</body>
</html>
