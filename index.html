<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Okke Bomb T-shirt | AR Experience</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>

   <script>
      AFRAME.registerComponent('sprite-sheet', {
        schema: {
          cols: {type: 'number', default: 1},
          rows: {type: 'number', default: 1},
          totalFrames: {type: 'number', default: 1},
          fps: {type: 'number', default: 24},
          loop: {type: 'boolean', default: true}
        },
        init: function () {
          this.timer = 0;
          this.currentFrame = 0;
          this.textureLoaded = false;

          // Função interna para configurar a textura quando ela estiver pronta
          this.setupTexture = () => {
            this.mesh = this.el.getObject3D('mesh');
            if (this.mesh && this.mesh.material.map) {
                this.texture = this.mesh.material.map;
                // AQUI é onde a mágica acontece: recorta a imagem
                this.texture.repeat.set(1 / this.data.cols, 1 / this.data.rows);
                this.updateOffset();
                this.textureLoaded = true;
            }
          };

          // Tenta rodar imediatamente (caso já esteja em cache)
          this.setupTexture();

          // Se não der certo, fica esperando o evento de carregamento do A-Frame
          this.el.addEventListener('materialtextureloaded', () => {
              this.setupTexture();
          });
        },
        tick: function (time, timeDelta) {
          // Se a textura ainda não carregou, não faz nada
          if (!this.textureLoaded || !this.texture) return;

          this.timer += timeDelta;
          
          if (this.timer > 1000 / this.data.fps) {
            this.currentFrame++;
            
            if (this.currentFrame >= this.data.totalFrames) {
              this.currentFrame = this.data.loop ? 0 : this.data.totalFrames - 1;
            }
            
            this.updateOffset();
            this.timer = 0;
          }
        },
        updateOffset: function () {
          if (!this.textureLoaded) return;
          
          const col = this.currentFrame % this.data.cols;
          const row = Math.floor(this.currentFrame / this.data.cols);
          
          this.texture.offset.x = col / this.data.cols;
          this.texture.offset.y = (this.data.rows - 1 - row) / this.data.rows;
        }
      });
    </script>
</head>

<body>
    <a-scene 
      mindar-image="imageTargetSrc: ./targets.mind; filterMinCF:0.0001; filterBeta: 0.001;" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">

        <a-assets>
            <img id="animacao-texture" src="./animacao_sprite.png" crossorigin="anonymous">
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            
            <a-image 
                src="#animacao-texture" 
                position="0 0 0" 
                scale="1.437 1 1" 
                rotation="0 0 0" 
                alpha-test="0.5"
                sprite-sheet="cols: 5; rows: 6; totalFrames: 26; fps: 24; loop: true">
            </a-image>
            
        </a-entity>
    </a-scene>
</body>
</html>
